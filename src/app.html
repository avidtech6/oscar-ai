<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="%sveltekit.assets%/favicon.svg" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta name="description" content="Oscar AI - Personal Arboricultural Notebook + Assistant for UK Tree Surveyors" />
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet" />
		<script>
			// Safe Mode flag - can be set via URL parameter or localStorage
			window.__OSCAR_SAFE_MODE = false;
			
			// Check for Safe Mode activation
			const urlParams = new URLSearchParams(window.location.search);
			if (urlParams.has('safe_mode') || localStorage.getItem('oscar_safe_mode') === 'true') {
				window.__OSCAR_SAFE_MODE = true;
				console.log('[SafeMode] Activated via URL parameter or localStorage');
			}
			
			window.addEventListener('error', (event) => {
				console.error('Early error:', event.error);
				localStorage.setItem('last_error', JSON.stringify({
					message: event.error?.message,
					stack: event.error?.stack,
					timestamp: new Date().toISOString()
				}));
				
				// Activate Safe Mode on critical errors
				if (event.error && (
					event.error.message.includes('Cannot read properties') ||
					event.error.message.includes('undefined') ||
					event.error.message.includes('import') ||
					event.error.message.includes('module')
				)) {
					console.error('[SafeMode] Critical error detected, activating Safe Mode');
					window.__OSCAR_SAFE_MODE = true;
					localStorage.setItem('oscar_safe_mode', 'true');
				}
			});
			
			window.addEventListener('unhandledrejection', (event) => {
				console.error('Early unhandled rejection:', event.reason);
				
				// Activate Safe Mode on module loading failures
				if (event.reason && event.reason.message && event.reason.message.includes('Failed to fetch dynamically imported module')) {
					console.error('[SafeMode] Module import failure, activating Safe Mode');
					window.__OSCAR_SAFE_MODE = true;
					localStorage.setItem('oscar_safe_mode', 'true');
				}
			});
			
			// Initialize Safe Mode if needed
			if (window.__OSCAR_SAFE_MODE) {
				console.log('[SafeMode] Safe Mode is active, loading fallback UI');
				// We'll let the SafeModeBootstrap handle the UI
			}
		</script>
		%sveltekit.head%
	</head>
	<body data-sveltekit-preload-data="hover">
		<div style="display: contents">%sveltekit.body%</div>
		<!-- Safe Mode Fallback UI (hidden by default) -->
		<div id="safe-mode-fallback" style="display: none;">
			<div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: white; z-index: 9999; padding: 2rem; font-family: sans-serif;">
				<div style="max-width: 600px; margin: 0 auto; padding-top: 4rem;">
					<h1 style="font-size: 2rem; margin-bottom: 1rem; color: #333;">⚠️ Oscar AI Safe Mode</h1>
					<p style="color: #666; margin-bottom: 2rem; line-height: 1.6;">
						The application encountered an error and has entered Safe Mode. This prevents further JavaScript errors and allows basic functionality.
					</p>
					
					<div style="background: #f8f9fa; border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem;">
						<h2 style="font-size: 1.25rem; margin-bottom: 1rem; color: #333;">Recovery Options</h2>
						<div style="display: flex; gap: 1rem; flex-wrap: wrap;">
							<button id="safe-mode-reload" style="padding: 0.75rem 1.5rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
								Reload Application
							</button>
							<button id="safe-mode-clear-storage" style="padding: 0.75rem 1.5rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
								Clear Local Storage
							</button>
							<button id="safe-mode-disable" style="padding: 0.75rem 1.5rem; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
								Disable Safe Mode
							</button>
						</div>
					</div>
					
					<div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 1rem; margin-bottom: 2rem;">
						<h3 style="font-size: 1rem; margin-bottom: 0.5rem; color: #856404;">Debug Information</h3>
						<pre id="safe-mode-error-info" style="font-size: 0.875rem; color: #666; overflow: auto; max-height: 200px; background: #f8f9fa; padding: 1rem; border-radius: 4px;">
							No error information available.
						</pre>
					</div>
					
					<p style="color: #999; font-size: 0.875rem;">
						If the problem persists, try clearing your browser cache or contact support.
					</p>
				</div>
			</div>
		</div>
		
		<script>
			// Initialize Safe Mode fallback UI if needed
			if (window.__OSCAR_SAFE_MODE) {
				const fallback = document.getElementById('safe-mode-fallback');
				if (fallback) {
					fallback.style.display = 'block';
					
					// Load error information
					const errorInfo = document.getElementById('safe-mode-error-info');
					const lastError = localStorage.getItem('last_error');
					if (lastError) {
						try {
							const error = JSON.parse(lastError);
							errorInfo.textContent = `Error: ${error.message}\n\nStack: ${error.stack || 'No stack trace'}\n\nTimestamp: ${error.timestamp}`;
						} catch (e) {
							errorInfo.textContent = `Error data: ${lastError}`;
						}
					}
					
					// Setup button handlers
					document.getElementById('safe-mode-reload')?.addEventListener('click', () => {
						window.location.reload();
					});
					
					document.getElementById('safe-mode-clear-storage')?.addEventListener('click', () => {
						localStorage.clear();
						sessionStorage.clear();
						window.location.reload();
					});
					
					document.getElementById('safe-mode-disable')?.addEventListener('click', () => {
						localStorage.removeItem('oscar_safe_mode');
						window.location.search = window.location.search.replace(/[?&]safe_mode=true/, '');
						window.location.reload();
					});
				}
			}
		</script>
	</body>
</html>
